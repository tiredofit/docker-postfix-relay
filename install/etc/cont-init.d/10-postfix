#!/usr/bin/with-contenv bash

source /assets/functions/00-container
prepare_service all
PROCESS_NAME="postfix-relay"

configure_data_dir
configure_monitoring
configure_postfix

if var_true "${ENABLE_AUTH}" ; then
	sanity_var SMTP_USER "SMTP Username"
	sanity_var SMTP_PASS "SMTP Password"
	configure_sasl
fi

configure_summary

### Execute Custom Scripts if exist to modify parts of the system
if [ -d /assets/custom-scripts/ ] ; then
  print_warn "Found Custom Scripts to Execute"
  for f in $(find /assets/custom-scripts/ -name \*.sh -type f); do
    print_warn "Running Script ${f}"
    chmod +x "${f}"
    ${f}
  done
fi

chown -f -R postfix:postfix ${DATA_LOCATION}/{active,bounce,corrupt,defer,deferred,flush,hold,incoming,private,saved,trace,var}
chown -f -R postfix:postdrop ${DATA_LOCATION}/{maildrop,public}
silent chown -f postfix:postfix ${DATA_LOCATION}/*.*
sudo -u postfix postmap lmdb:${DATA_LOCATION}/var/sasl_passwd
newaliases

liftoff